<div id="widget-chat">
    <h2 id="titulo">Chat de la oferta:</h2>
    <h5 id="datos_oferta"></h5>
    <div id="chat-container">
    </div>
</div>
<div>
    <input type="text" class="form-control"
           placeholder="Escribe aquí tu mensaje" id="textomensaje" name="mensaje"/>
    <span class="input-group-btn">
             <button class="btn btn-primary" onclick="enviarMensaje()" id="enviarMensaje">Enviar</button>
        </span>
</div>

<script>
    function cargarMensajes() {
        $.ajax({
            url : URLbase + "/mensajes/" + productoSeleccionado,
            type : "GET",
            dataType : 'json',
            headers : {
                "token" : token,
                "conversacion" : conversacionSeleccionada
            },
            success : function(respuesta) {
                actualizarMensajesChat(respuesta);
                actualizarDatosExtraChat(usuarioReceptor, nombreProducto);
            },
            error : function(error) {
                console.log("Error al cargar los mensajes");
            }
        });
    }

    function actualizarDatosExtraChat(nombrePropietario, nombreProducto){
        let encabezadoDatos = $("#datos_oferta");
        encabezadoDatos.empty();
        encabezadoDatos.append("Usuario: " + nombrePropietario + " <br /> Producto: " + nombreProducto);
    }


    function actualizarMensajesChat(mensajesMostrar) {
        let codigoTabla = "";
        $("#chat-container").empty();
        for(let i = 0; i < mensajesMostrar.length; i++){
            // Comprobamos si somos autor, entonces no hay que marcar como leído
            if(Cookies.get('usuario') === mensajesMostrar[i].emisor && !mensajesMostrar[i].leido){
                codigoTabla += "<h4 class='mensaje_propio_no_leido'>"+ mensajesMostrar[i].texto +"</h4><br>";
            }
            else if(Cookies.get('usuario') === mensajesMostrar[i].emisor && mensajesMostrar[i].leido) {
                codigoTabla += "<h4 class='mensaje_propio_leido'>"+ mensajesMostrar[i].texto +"<span>&#10003;</span></h4><br>";
            }else if(Cookies.get('usuario') !== mensajesMostrar[i].emisor && !mensajesMostrar[i].leido){
                marcarMensajeComoLeido(mensajesMostrar[i]._id);
                codigoTabla += "<h4 class='mensaje_otro'>"+ mensajesMostrar[i].texto +"</h4><br>";
            }else{
                codigoTabla += "<h4 class='mensaje_otro'>"+ mensajesMostrar[i].texto +"</h4><br>";
            }
        }

        $("#chat-container").append(codigoTabla);
    }

    function enviarMensaje() {
        $.ajax({
            url: URLbase + "/enviarmensaje",
            type: "POST",
            data: {
                producto: productoSeleccionado,
                texto: $("#textomensaje").val(),
                recep : usuarioReceptor
            },
            dataType: 'json',
            headers: {
                "token": token,
            },
            //Después de enviar, refrescar para mostrar y limpiar el input
            success: function (respuesta) {
                cargarMensajes();
                $("#textomensaje").val('');
            },
            error: function (error) {
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }

    //Refresco cada segundo según guion (falta testear)
    setInterval(function() {
        if( $("#titulo").is(":visible")){
            cargarMensajes();
        }
    }, 1000);


    function marcarMensajeComoLeido(mensajeMarcar) {
        $.ajax({
            url: URLbase + "/mensajes/marcarleido/" + mensajeMarcar,
            type: "PUT",
            headers: {"token": token},
            dataType: 'json',
            success: function (respuesta) {
                console.log("mensaje " + mensajeMarcar + " marcado como leído correctamente");
            },
            error: function (error) {
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }
</script>